<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Fluent-plugin-azurefunctions by yokawasa</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Fluent-plugin-azurefunctions</h1>
          <h2>Azure Functions (HTTP Trigger) output plugin for Fluentd</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/yokawasa/fluent-plugin-azurefunctions/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/yokawasa/fluent-plugin-azurefunctions/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/yokawasa/fluent-plugin-azurefunctions" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a id="fluent-plugin-azurefunctions" class="anchor" href="#fluent-plugin-azurefunctions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>fluent-plugin-azurefunctions</h1>

<p><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">Azure Functions</a> (HTTP Trigger) output plugin for Fluentd. The plugin aggregates semi-structured data in real-time and writes the buffered data via HTTPS request to HTTP Trigger Function.</p>

<p><img src="https://github.com/yokawasa/fluent-plugin-azurefunctions/raw/master/img/Azure-Functions-Fluentd.png" alt="fluent-plugin-azurefunctions overview"></p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>$ gem install fluent-plugin-azurefunctions
</code></pre>

<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>

<h3>
<a id="azure-functions" class="anchor" href="#azure-functions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Azure Functions</h3>

<p>Create a function (HTTP Trigger). First, you need to have an function app that hosts the execution of your functions in Azure if you don't already have. Once you have an function app, you can create a function. Here are instructions:</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function">Create your first Azure Function</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference">Azure Functions developer reference</a></li>
</ul>

<p>A quick-start HTTP trigger function sample is included under examples/function-csharp:</p>

<pre><code>examples/function-csharp
  - function.json    (Configurations for Azure Functions)
  - project.json     (Configurations for package dependencies)
  - run.csx          (Function code)
</code></pre>

<h3>
<a id="fluentd---fluentconf" class="anchor" href="#fluentd---fluentconf" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Fluentd - fluent.conf</h3>

<pre><code>&lt;match azurefunctions.**&gt;
    @type azurefunctions
    endpoint  AZURE_FUNCTION_ENDPOINT   # ex. https://&lt;accountname&gt;.azurewebsites.net/api/&lt;functionname&gt;
    function_key AZURE_FUNCTION_KEY     # ex. aRVQ7Lj0vzDhY0JBYF8gpxYyEBxLwhO51JSC7X5dZFbTvROs7uNg==
    key_names key1,key2,key3
    add_time_field true
    time_field_name mytime
    time_format %s
    localtime true
    add_tag_field true
    tag_field_name mytag
&lt;/match&gt;
</code></pre>

<ul>
<li>
<strong>endpoint (required)</strong> - Azure Functions Endpoint URL</li>
<li>
<strong>function_key (required)</strong> - Azure Functions API Key</li>
<li>
<strong>key_names (optional)</strong> - Key names in incoming records to post to Azure functions HTTP Trigger functions. Each key needs to be separated by a comma. If key_names not specified, all incoming records are posted. If incoming records contain the same key names as the ones specified in time_field_name and tag_field_name, their values are replaced by the values of time_field_name and tag_field_name</li>
<li>
<strong>add_time_field (optional)</strong> - Default:true. This option allows to insert a time field to record</li>
<li>
<strong>time_field_name (optional)</strong> - Default:time. This is required only when add_time_field is true</li>
<li>
<strong>localtime (optional)</strong> - Default:false. Time record is inserted with UTC (Coordinated Universal Time) by default. This option allows to use local time if you set localtime true. This is valid only when add_time_field is true</li>
<li>
<strong>time_format (optional)</strong> -  Default:%s. Time format for a time field to be inserted. Default format is %s, that is unix epoch time. If you want it to be more human readable, set this %Y%m%d-%H:%M:%S, for example. This is valid only when add_time_field is true.</li>
<li>
<strong>add_tag_field (optional)</strong> - Default:false. This option allows to insert a tag field to record</li>
<li>
<strong>tag_field_name (optional)</strong> - Default:tag. This is required only when add_time_field is true</li>
</ul>

<h2>
<a id="configuration-examples" class="anchor" href="#configuration-examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration examples</h2>

<p>fluent-plugin-azurefunctions adds <strong>.rid</strong> attribute which is UUID format and any other attributes of record automatically. In addition, it adds <strong>time</strong> and <strong>tag</strong> attributes if <strong>add_time_field</strong> and <strong>add_tag_field</strong> are true respectively. Below are two types of the plugin configurations - Default and All options configuration.</p>

<h3>
<a id="1-default-configuration-no-options" class="anchor" href="#1-default-configuration-no-options" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>(1) Default Configuration (No options)</h3>

<p>fluent.conf</p>

<pre><code>&lt;source&gt;
    @type forward
    @id forward_input
&lt;/source&gt;

&lt;match azurefunctions.**&gt;
    @type azurefunctions
    endpoint https://yoichikademo.azurewebsites.net/api/HttpTriggerFunction
    function_key aRVQ7Lj0vzDhY0JBYF8gpxYyEBxLwhO51JSC7X5dZFbTvROs7uNg==(dummy)
&lt;/match&gt;
</code></pre>

<p>The plugin write all records in incoming event stream out to Azure Functions:</p>

<pre><code># Generating test event using fluent-cat
echo ' { "key1":"value1", "key2":"value2", "key3":"value3"}' | fluent-cat azurefunctions.msg

# HTTP POST request body to Azure Functions
{
    "payload": '{"key1":"value1", "key2":"value2", "key3":"value3", "time":"1479741633"}'
}
</code></pre>

<h3>
<a id="2-configuration-with-all-options" class="anchor" href="#2-configuration-with-all-options" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>(2) Configuration with All Options</h3>

<p>fluent.conf</p>

<pre><code>&lt;source&gt;
    @type forward
    @id forward_input
&lt;/source&gt;

&lt;match azurefunctions.**&gt;
    @type azurefunctions
    endpoint https://yoichikademo.azurewebsites.net/api/HttpTriggerFunction
    function_key aRVQ7Lj0vzDhY0JBYF8gpxYyEBxLwhO51JSC7X5dZFbTvROs7uNg==(dummy)
    key_names key1,key2
    add_time_field true
    time_field_name mytime
    time_format %s
    localtime true
    add_tag_field true
    tag_field_name mytag
&lt;/match&gt;
</code></pre>

<p>The plugin write only records that are specified by key_names in incoming event stream out to Azure Functions:</p>

<pre><code># Generating test event using fluent-cat
echo ' { "key1":"value1", "key2":"value2", "key3":"value3"}' | fluent-cat azurefunctions.msg

# HTTP POST request body to Azure Functions
{
    "payload": '{"key1":"value1", "key2":"value2", "time":"1479741633", "tag":"azurefunctions.msg"}'
}
</code></pre>

<h2>
<a id="tests" class="anchor" href="#tests" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tests</h2>

<h3>
<a id="running-test-code" class="anchor" href="#running-test-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Running test code</h3>

<pre><code>$ git clone https://github.com/yokawasa/fluent-plugin-azurefunctions.git
$ cd fluent-plugin-azurefunctions

# edit CONFIG params of test/plugin/test_azurefunctions.rb
$ vi test/plugin/test_azurefunctions.rb

# run test
$ rake test
</code></pre>

<h3>
<a id="creating-package-running-and-testing-locally" class="anchor" href="#creating-package-running-and-testing-locally" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Creating package, running and testing locally</h3>

<pre><code>$ rake build
$ rake install:local

# running fluentd with your fluent.conf
$ fluentd -c fluent.conf -vv &amp;

# generate test event
$ echo ' { "key1":"value1", "key2":"value2", "key3":"value3"}' | fluent-cat azurefunctions.msg
</code></pre>

<h2>
<a id="change-log" class="anchor" href="#change-log" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Change log</h2>

<ul>
<li><a href="ChangeLog.md">Changelog</a></li>
</ul>

<h2>
<a id="links" class="anchor" href="#links" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Links</h2>

<ul>
<li><a href="https://rubygems.org/gems/fluent-plugin-azurefunctions">https://rubygems.org/gems/fluent-plugin-azurefunctions</a></li>
<li><a href="http://unofficialism.info/posts/fluent-plugin-azurefunctions/">http://unofficialism.info/posts/fluent-plugin-azurefunctions/</a></li>
</ul>

<h2>
<a id="contributing" class="anchor" href="#contributing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contributing</h2>

<p>Bug reports and pull requests are welcome on GitHub at <a href="https://github.com/yokawasa/fluent-plugin-azurefunctions">https://github.com/yokawasa/fluent-plugin-azurefunctions</a>.</p>

<h2>
<a id="copyright" class="anchor" href="#copyright" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Copyright</h2>

<table>
  <tr>
    <td>Copyright</td>
<td>Copyright (c) 2016- Yoichi Kawasaki</td>
  </tr>
  <tr>
    <td>License</td>
<td>Apache License, Version 2.0</td>
  </tr>
</table>
        </section>

        <footer>
          Fluent-plugin-azurefunctions is maintained by <a href="https://github.com/yokawasa">yokawasa</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>
